# VSCode変数表示拡張機能 MVP開発のPBI（Product Backlog Item）

## 🎯 プロジェクト概要
VSCodeのサイドバーに現在開いているファイルの変数名を辞書形式で表示する拡張機能。変数の役割説明をローカルLLM（LLM Studioサーバー）から取得して表示する。

## 📋 PBI一覧

### **PBI-1: ファイル解析ボタン機能の実装** ✅ **完了**
**優先度:** 高  
**ストーリーポイント:** 3  
**説明:** ボタン押下で現在のアクティブファイル内容を取得し、WebViewに表示する機能を実装する。

**受け入れ基準:**
- [x] 「ファイルを解析」ボタンの実装
- [x] 現在のアクティブファイルの内容取得
- [x] 全言語サポート（言語制限なし）
- [x] ファイル情報とプレビューの表示

---

### **PBI-2: LLM Studioサーバー通信機能の実装** ✅ **完了**
**優先度:** 高  
**ストーリーポイント:** 5  
**説明:** ローカルLLMサーバーへのHTTP通信機能を実装し、ファイル内容をプロンプトとして送信して変数の役割説明を取得する。

**LLMプロンプト形式:**
```
このコードファイルの全ての変数とその役割を分析してください：

[ファイル内容]

JSON形式で変数名と役割説明を返してください。
```

**受け入れ基準:**
- [x] LLM StudioサーバーへのHTTP POST通信ができる
- [x] 上記プロンプト形式でファイル内容を送信できる
- [x] JSON形式のレスポンスをパースできる
- [x] 通信エラー時の適切なハンドリングができる
- [x] タイムアウト設定が適用される

---

### **PBI-3: 変数辞書表示WebView UIの作成** ✅ **完了（PBI-2で実装済み）**
**優先度:** 高  
**ストーリーポイント:** 4  
**説明:** LLMから取得した変数の役割説明を辞書形式（変数名 | 役割）で表示するWebView UIを作成する。

**受け入れ基準:**
- [x] 変数名と役割説明のテーブル表示ができる
- [x] VSCodeテーマに適応したデザインになっている
- [x] レスポンシブデザインが適用されている
- [ ] 変数の検索・フィルタリング機能がある（新PBIで実装予定）
- [x] ローディング状態の表示ができる

---

### **PBI-4: LLM応答による役割説明表示機能** ✅ **完了（PBI-2で実装済み）**
**優先度:** 高  
**ストーリーポイント:** 4  
**説明:** LLMからの応答をパースして変数ごとの説明を表示し、マークダウン形式での説明をサポートする。

**受け入れ基準:**
- [x] LLMの応答を変数ごとの説明にパースできる
- [ ] マークダウン形式の説明を適切にレンダリングできる（新PBIで実装予定）
- [x] 説明が取得できない変数に対する適切な表示ができる
- [ ] 説明の更新・再取得機能がある（新PBIで実装予定）
- [x] 説明の文字数制限や表示形式の調整ができる

---

### **PBI-5: 設定管理機能（LLMサーバーURL等）** ✅ **完了（PBI-2で実装済み）**
**優先度:** 中  
**ストーリーポイント:** 3  
**説明:** VSCode設定でLLMサーバーURLとAPIキーを管理し、設定変更時の自動反映を実装する。

**受け入れ基準:**
- [x] VSCode設定画面でLLMサーバーURLを設定できる
- [ ] APIキーやその他認証情報の設定ができる（新PBIで実装予定）
- [x] 設定変更時に拡張機能が自動で新しい設定を適用する
- [x] デフォルト設定値が適切に設定されている
- [ ] 設定の検証機能がある（新PBIで実装予定）

---

### **PBI-6: エラーハンドリングとローディング状態の実装** ✅ **完了（PBI-2で実装済み）**
**優先度:** 中  
**ストーリーポイント:** 3  
**説明:** LLM通信エラー時の適切な表示とローディングスピナー、プログレス表示を実装する。

**受け入れ基準:**
- [x] LLM通信エラー時にユーザーフレンドリーなエラーメッセージが表示される
- [x] ローディング中のスピナー表示がある
- [x] プログレス表示で処理状況が分かる
- [ ] リトライ機能が提供される（新PBIで実装予定）
- [x] タイムアウト時の適切な処理ができる

---

### **PBI-7: インタラクティブ変数辞書編集機能** ✅ **完了**
**優先度:** 高  
**ストーリーポイント:** 3  
**説明:** LLMが生成した変数の役割説明を開発者が直接編集・修正できるインタラクティブ機能を実装する。永続化や視覚的区別機能は除外してシンプルな編集機能のみを提供する。

**受け入れ基準:**
- [x] 変数テーブルの各役割セルがクリックで編集モードになる
- [x] 編集中は入力フィールドが表示される
- [x] Enter キーで編集確定、Escape キーでキャンセル
- [x] ~~編集後の内容がローカルストレージに保存される~~ **スコープ外（不要）**
- [x] ~~ファイルを再解析しても編集内容が保持される~~ **スコープ外（不要）**
- [x] ~~編集済みの変数には視覚的な区別（アイコンや色）がある~~ **スコープ外（不要）**
- [x] ~~編集内容をリセットしてLLM生成値に戻す機能がある~~ **スコープ外（不要）**

---

### **PBI-8: 変数辞書の永続化とエクスポート機能** ❌ **キャンセル**
**優先度:** 中  
**ストーリーポイント:** 4  
**説明:** 編集した変数辞書をファイルに保存・エクスポートし、プロジェクト間で共有できる機能を実装する。

**キャンセル理由:** エクスポート機能は不要との判断により、このPBIはキャンセルとなりました。

**受け入れ基準:**
- [ ] ~~変数辞書をJSONファイルとしてエクスポートできる~~ **キャンセル**
- [ ] ~~エクスポートしたファイルをインポートできる~~ **キャンセル**
- [ ] ~~プロジェクトごとの変数辞書管理ができる~~ **キャンセル**
- [ ] ~~Markdownテーブル形式でのエクスポートができる~~ **キャンセル**
- [ ] ~~複数ファイルの変数辞書を統合表示できる~~ **キャンセル**

---

### **PBI-9: マルチプロバイダー対応（OpenAI API等）**
**優先度:** 中  
**ストーリーポイント:** 5  
**説明:** ローカルLLMに加えて、OpenAI API、Claude API等の外部LLMプロバイダーを選択可能にする機能を実装する。

**受け入れ基準:**
- [ ] 設定でLLMプロバイダーを選択できる（local/openai/claude等）
- [ ] OpenAI APIキーの設定と認証ができる
- [ ] 各プロバイダーごとのモデル選択ができる（gpt-3.5-turbo, gpt-4等）
- [ ] APIキーのセキュアな保存ができる
- [ ] プロバイダー別のエラーハンドリングができる
- [ ] コスト概算表示機能がある
- [ ] プロバイダー切り替えが即座に反映される

---

### **PBI-10: LLM変数認識の一貫性向上**
**優先度:** 中  
**ストーリーポイント:** 4  
**説明:** LLMによる変数抽出結果の一貫性を向上させ、同じコードから常に同じ変数セットが抽出されるようにする。

**受け入れ基準:**
- [ ] 変数定義基準を明確化したプロンプト改善ができる
- [ ] temperature設定を0.0に調整して一貫性を向上できる
- [ ] 前回結果との比較機能がある
- [ ] 変数数が大幅に異なる場合の警告表示ができる
- [ ] 変数認識ルールの設定画面がある
- [ ] 同一ファイルでの複数回実行で90%以上の一貫性を達成する

---

### **PBI-11: 高度なUI機能強化**
**優先度:** 中  
**ストーリーポイント:** 6  
**説明:** カードの視覚的階層、インタラクション強化、検索・フィルター機能などの高度なUI機能を実装する。

**受け入れ基準:**
- [ ] 変数タイプ別の色分け・アイコン表示ができる
- [ ] カードのホバーエフェクトとマイクロアニメーション追加
- [ ] 変数名での検索機能がある
- [ ] 型別フィルタリング機能がある
- [ ] 空状態時の親しみやすいメッセージ表示
- [ ] 解析進行状況のパーセンテージ表示
- [ ] 編集時のフォーカス状態をより明確に表示

---

### **PBI-12: テスト実装とデバッグ**
**優先度:** 低  
**ストーリーポイント:** 5  
**説明:** ユニットテストとインテグレーションテストを実装し、パフォーマンス最適化を行う。

**受け入れ基準:**
- [ ] 主要機能のユニットテストが実装されている
- [ ] エンドツーエンドのインテグレーションテストがある
- [ ] パフォーマンステストが実行される
- [ ] メモリリークの検証ができる
- [ ] 大きなファイルでの動作確認ができる

---

## 🚀 実装順序
1. ✅ PBI-1: ファイル解析ボタン機能 **完了**
2. ✅ PBI-2: LLM Studioサーバー通信機能 **完了**
3. ✅ PBI-3: 変数辞書表示WebView UI **完了（PBI-2で実装済み）**
4. ✅ PBI-4: LLM応答による役割説明表示 **完了（PBI-2で実装済み）**
5. ✅ PBI-5: 設定管理機能 **完了（PBI-2で実装済み）**
6. ✅ PBI-6: エラーハンドリング **完了（PBI-2で実装済み）**
7. ✅ PBI-7: インタラクティブ変数辞書編集機能 **完了**
8. ❌ PBI-8: 変数辞書の永続化とエクスポート機能 **キャンセル**
9. PBI-9: マルチプロバイダー対応（OpenAI API等） **→ 次の実装対象**
10. PBI-10: LLM変数認識の一貫性向上
11. PBI-11: 高度なUI機能強化
12. PBI-12: テスト実装

## 📊 総見積もり（PBI-11追加、PBI-8キャンセル後）
- **完了済みストーリーポイント:** 25pt (3+5+4+4+3+3+3)
- **キャンセルストーリーポイント:** 4pt (PBI-8)
- **残りストーリーポイント:** 20pt (5+4+6+5)
- **総ストーリーポイント:** 49pt (完了25pt + キャンセル4pt + 残り20pt)
- **完了率:** 51% (25pt/49pt)
- **MVP完成目標:** **既に達成済み**
- **拡張機能完成目標:** PBI-9〜PBI-12の完了時点

## 💡 設計変更
- **PBI-2（変数抽出パーサー）を削除**: LLMがファイル全体を解析して変数を自動識別するため、専用パーサーは不要
- **LLMプロンプト方式**: シンプルなファイル内容丸投げで、JSON形式の変数辞書を取得